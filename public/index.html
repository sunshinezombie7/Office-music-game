<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Not Songlio</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #1a1a2e; color: #fff; padding: 20px; text-align: center; padding-bottom: 200px; } 
        .container { max-width: 800px; margin: 0 auto; }
        h1 { color: #3498db; margin-bottom: 10px; }
        .screen { background: #232336; padding: 25px; border-radius: 10px; margin: 20px 0; border: 1px solid #444; }
        .hidden { display: none !important; }
        input[type="text"] { padding: 10px; width: 70%; border-radius: 5px; border: 1px solid #555; background: #111; color: white; font-size: 1.1rem;}
        button { padding: 10px 20px; border-radius: 5px; border: none; cursor: pointer; font-weight: bold; margin: 5px; background: #3498db; color: white; }
        button:disabled { background: #555; cursor: not-allowed; }
        button.host-btn { background: #2ecc71; }
        button.danger-btn { background: #e74c3c; padding: 2px 8px; font-size: 0.8rem; margin: 0 0 0 10px; }
        .song-item { background: #2a2a3a; padding: 10px; margin: 5px 0; cursor: pointer; border-radius: 5px; text-align: left; }
        .song-item:hover { background: #333; }
        .song-item.selected { border-left: 5px solid #9b59b6; background: #333; }
        #playerList li, #scoreList li, #runnerUpList li { background: #111; padding: 10px; margin: 5px 0; display: flex; justify-content: space-between; border-radius: 5px; align-items: center; }
        .progress-container { width: 100%; height: 8px; background: #444; margin: 15px 0; border-radius: 4px; }
        .progress-bar { height: 100%; background: #2ecc71; width: 0%; transition: width 0.5s; }
        #countdown { font-size: 3rem; font-weight: bold; color: #e74c3c; margin: 10px 0; }
        .guess-correct { color: #2ecc71; font-weight: bold; margin: 10px; font-size: 1.2rem; }
        .guess-incorrect { color: #e74c3c; font-weight: bold; margin: 10px; }
        
        #bottomPanel { position: fixed; bottom: 0; left: 0; width: 100%; background: #16213e; border-top: 2px solid #3498db; padding: 10px; z-index: 100; display: flex; flex-direction: column; align-items: center; }
        #chatBox { width: 90%; max-width: 800px; height: 120px; overflow-y: auto; background: #111; border: 1px solid #444; border-radius: 5px; padding: 10px; margin-bottom: 10px; text-align: left; }
        #inputRow { width: 100%; max-width: 800px; display: flex; gap: 10px; }
        #inputRow input { flex: 1; }
        
        .chat-msg { margin: 2px 0; font-size: 0.9rem; }
        .chat-wrong { color: #ccc; }
        .chat-correct { color: #2ecc71; font-weight: bold; font-style: italic; }
        .chat-winner { color: #f1c40f; font-weight: bold; }
        .chat-dj { color: #9b59b6; font-weight: bold; } 
        .chat-name { font-weight: bold; } 
        .input-winner { border: 2px solid #2ecc71 !important; color: #2ecc71 !important; }

        .podium-container { display: flex; justify-content: center; align-items: flex-end; height: 300px; margin-bottom: 30px; gap: 10px; }
        .pillar { display: flex; flex-direction: column; justify-content: flex-end; align-items: center; width: 100px; border-radius: 10px 10px 0 0; color: #1a1a2e; font-weight: bold; text-align: center; padding-bottom: 10px; position: relative; }
        .pillar-name { position: absolute; top: -40px; width: 100%; color: #fff; font-size: 1.1rem; font-weight: bold; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .pillar-score { font-size: 1.5rem; }
        .rank-label { font-size: 3rem; opacity: 0.3; margin-bottom: 10px; }
        .gold { background: linear-gradient(to top, #f1c40f, #f39c12); height: 220px; order: 2; z-index: 10; box-shadow: 0 0 20px rgba(241, 196, 15, 0.3); }
        .silver { background: linear-gradient(to top, #bdc3c7, #95a5a6); height: 160px; order: 1; }
        .bronze { background: linear-gradient(to top, #cd6133, #d35400); height: 110px; order: 3; }
        #activeSubmitter { font-style: italic; color: #9b59b6; margin-bottom: 10px; }
        .status-message { color: #e74c3c; margin-top: 10px; font-weight: bold; display: none; }

        .color-options { display: flex; justify-content: center; gap: 10px; margin: 15px 0; flex-wrap: wrap; }
        .color-dot { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: transform 0.2s; }
        .color-dot:hover { transform: scale(1.2); }
        .color-dot.selected { border: 2px solid #fff; box-shadow: 0 0 10px rgba(255,255,255,0.5); transform: scale(1.1); }
        .player-dot { width: 12px; height: 12px; border-radius: 50%; margin-right: 10px; display: inline-block; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéµ Not Songlio üéµ</h1>
        <div class="screen" id="loginScreen">
            <h2>Join Game</h2>
            <input type="text" id="playerName" placeholder="Enter your name..." maxlength="15">
            <p style="margin: 15px 0 5px; font-size: 0.9rem; color: #ccc;">Choose your color:</p>
            <div class="color-options" id="colorPicker"></div>
            <br>
            <button id="joinBtn">Join</button>
            <div id="loginStatus" class="status-message"></div>
        </div>
        <div class="screen hidden" id="submissionScreen">
            <h2>Pick a Song</h2>
            <div style="margin-bottom: 15px;">
                <input type="text" id="searchInput" placeholder="Song or Artist...">
                <button id="searchBtn">Search</button>
            </div>
            <div id="searchResults" class="hidden"></div>
            <div id="selectedSong" class="hidden">
                <h3 id="selTitle" style="color:#f39c12"></h3>
                <p id="selArtist"></p>
                <audio id="previewAudio" controls style="width: 100%; margin: 10px 0;"></audio>
                <br>
                <button id="submitSongBtn" class="host-btn">Submit This Song</button>
            </div>
            <div id="waitingArea" class="hidden" style="margin-top:20px; border-top:1px solid #444; padding-top:10px;">
                <h3>Waiting for Players...</h3>
                <p>Submitted: <span id="submittedCount">0</span>/<span id="totalPlayers">0</span></p>
                <ul id="playerList"></ul>
            </div>
            <div class="host-controls hidden" id="hostControls">
                <button id="startGameBtn" class="host-btn" disabled>Start Game</button>
            </div>
        </div>
        
        <div class="screen hidden" id="gameScreen">
            <h2>Guess the Song!</h2>
            <div class="progress-container"><div class="progress-bar" id="gameProgress"></div></div>
            <p>Track <span id="trackNum">1</span></p>
            <p id="activeSubmitter">Picked by: ???</p>
            <div id="countdown">30</div>
            <audio id="gameAudio" style="display:none"></audio>
            
            <div id="revealArea" class="hidden">
                <img id="albumArt" src="" style="width:150px; border-radius:10px;">
                <h3 id="revealTitle" style="color:#f39c12; margin-top:10px;">Title</h3>
                <p id="revealArtist" style="color:#3498db">Artist</p>
                <p id="revealSubmitter" style="color:#9b59b6; font-style:italic;">Picked by: ???</p>
            </div>
            
            <div id="scoreboard" style="margin-top: 30px; text-align: left;">
                <h3>Scores</h3>
                <ul id="scoreList"></ul>
            </div>
        </div>

        <div class="screen hidden" id="resultsScreen">
            <h2>üèÜ Game Over! üèÜ</h2>
            <div id="podium" class="podium-container"></div>
            <div id="runnerUps" style="text-align: left; margin-top: 30px;">
                <h3>The Rest</h3>
                <ul id="runnerUpList"></ul>
            </div>
            <button id="playAgainBtn" class="host-btn" style="margin-top: 20px;">Play Again</button>
        </div>
    </div>

    <div id="bottomPanel" class="hidden">
        <div id="chatBox"></div>
        <div id="inputRow">
            <input type="text" id="guessInput" placeholder="Type guess..." autocomplete="off">
            <button id="submitGuessBtn">Send</button>
        </div>
        <div id="guessFeedback" style="height: 20px; margin-top: 5px; font-weight: bold;"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io(); 
        let myId = null;
        let selectedTrack = null;
        let myColor = '#3498db'; 

        // COLOR PICKER
        const colors = ['#e74c3c', '#e67e22', '#f1c40f', '#2ecc71', '#1abc9c', '#3498db', '#9b59b6', '#ff7979'];
        const picker = document.getElementById('colorPicker');
        if (picker) {
            picker.innerHTML = ''; 
            colors.forEach(c => {
                const dot = document.createElement('div');
                dot.className = 'color-dot';
                dot.style.backgroundColor = c;
                dot.onclick = () => {
                    Array.from(picker.children).forEach(d => d.classList.remove('selected'));
                    dot.classList.add('selected');
                    myColor = c;
                };
                picker.appendChild(dot);
            });
            if (picker.children.length > 0) {
                picker.children[0].classList.add('selected');
                myColor = colors[0];
            }
        }

        socket.on('connect', () => { myId = socket.id; });
        socket.on('playerJoined', (data) => {
            updateLobby(data);
            if(data.hostId === myId) document.getElementById('hostControls').classList.remove('hidden');
        });
        socket.on('loginError', (msg) => { const el = document.getElementById('loginStatus'); el.textContent = msg; el.style.display = 'block'; setTimeout(() => el.style.display = 'none', 3000); });
        socket.on('searchResults', (results) => {
            const container = document.getElementById('searchResults');
            container.innerHTML = '';
            container.classList.remove('hidden');
            results.forEach(track => {
                const div = document.createElement('div');
                div.className = 'song-item';
                div.innerHTML = `<strong>${track.trackName}</strong> - ${track.artistName}`;
                div.onclick = () => {
                    selectedTrack = track;
                    document.getElementById('selectedSong').classList.remove('hidden');
                    document.getElementById('selTitle').textContent = track.trackName;
                    document.getElementById('selArtist').textContent = track.artistName;
                    document.getElementById('previewAudio').src = track.previewUrl;
                };
                container.appendChild(div);
            });
        });
        socket.on('songSubmitted', (data) => {
            updateLobby(data);
            if(data.isReady) document.getElementById('startGameBtn').disabled = false;
        });
        
        socket.on('gameStarted', (data) => {
            showScreen('gameScreen');
            document.getElementById('bottomPanel').classList.remove('hidden');
        });

        socket.on('chatMessage', (data) => {
            const chatBox = document.getElementById('chatBox');
            const div = document.createElement('div');
            div.className = 'chat-msg';
            const nameSpan = `<span class="chat-name" style="color: ${data.color || '#3498db'}">${data.name}:</span>`;
            if(data.type === 'correct') {
                div.innerHTML = `${nameSpan} <span class="chat-correct">${data.text}</span>`;
            } else if (data.type === 'winner-chat') {
                div.innerHTML = `${nameSpan} <span class="chat-winner">${data.text}</span>`;
            } else if (data.type === 'dj-chat') {
                div.innerHTML = `${nameSpan} <span class="chat-dj">${data.text}</span>`;
            } else {
                div.innerHTML = `${nameSpan} <span class="chat-wrong">${data.text}</span>`;
            }
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        });

        socket.on('playTrack', (data) => {
            document.getElementById('revealArea').classList.add('hidden');
            const chatBox = document.getElementById('chatBox');
            const separator = document.createElement('div');
            separator.style.cssText = "text-align: center; opacity: 0.5; margin: 10px 0; font-size: 0.8rem; border-top: 1px solid #333; padding-top: 5px;";
            separator.textContent = `--- Round ${data.trackIndex + 1} ---`;
            chatBox.appendChild(separator);
            document.getElementById('activeSubmitter').textContent = "Picked by: " + data.submitterName;
            const input = document.getElementById('guessInput');
            input.value = '';
            input.disabled = false;
            input.classList.remove('input-winner');
            input.placeholder = "Type guess...";
            input.focus();
            document.getElementById('guessFeedback').textContent = '';
            document.getElementById('trackNum').textContent = data.trackIndex + 1;
            const audio = document.getElementById('gameAudio');
            audio.src = data.track.previewUrl;
            audio.volume = 0.5;
            audio.play().catch(e => console.log("Autoplay blocked"));
            document.getElementById('countdown').textContent = data.roundCountdown;
        });

        socket.on('countdown', (t) => document.getElementById('countdown').textContent = t);
        
        socket.on('roundEnded', (data) => {
            document.getElementById('revealArea').classList.remove('hidden');
            document.getElementById('revealTitle').textContent = data.track.title;
            document.getElementById('revealArtist').textContent = data.track.artist;
            document.getElementById('revealSubmitter').textContent = "Picked by: " + data.submitterName;
            document.getElementById('albumArt').src = data.track.albumArt || '';
            document.getElementById('gameAudio').pause();
            updateScores(data.scores, 'scoreList');
            const input = document.getElementById('guessInput');
            input.placeholder = "Round over. Chat away...";
        });

        socket.on('guessResult', (data) => {
            const fb = document.getElementById('guessFeedback');
            const input = document.getElementById('guessInput');
            if(data.silent) { input.value = ''; input.focus(); return; }
            if(data.correct) {
                fb.textContent = `‚úÖ Correct! +${data.points}`;
                fb.className = "guess-correct";
                input.classList.add('input-winner');
                input.placeholder = "Chat with others...";
                input.value = '';
                input.focus();
            } else {
                fb.textContent = data.message ? "‚ö†Ô∏è " + data.message : "‚ùå";
                fb.className = "guess-incorrect";
                input.value = ''; 
                input.disabled = false;
                input.focus();
            }
        });

        socket.on('gameFinished', (data) => {
            showScreen('resultsScreen');
            
            // --- 2. TRIGGER CONFETTI! ---
            const duration = 3000;
            const end = Date.now() + duration;
            (function frame() {
                confetti({ particleCount: 5, angle: 60, spread: 55, origin: { x: 0 } });
                confetti({ particleCount: 5, angle: 120, spread: 55, origin: { x: 1 } });
                if (Date.now() < end) requestAnimationFrame(frame);
            }());

            const podium = document.getElementById('podium');
            const runnerList = document.getElementById('runnerUpList');
            podium.innerHTML = '';
            runnerList.innerHTML = '';
            const allPlayers = Object.values(data.scores).sort((a,b) => b.score - a.score);
            const top3 = allPlayers.slice(0, 3);
            
            const createPillar = (player, rankClass, rankNum) => {
                if(!player) return;
                const div = document.createElement('div');
                div.className = `pillar ${rankClass}`;
                div.innerHTML = `<div class="pillar-name" style="color:${player.color}">${player.name}</div><div class="rank-label">${rankNum}</div><div class="pillar-score">${player.score}</div>`;
                podium.appendChild(div);
            };
            createPillar(top3[1], 'silver', '2nd');
            createPillar(top3[0], 'gold', '1st');
            createPillar(top3[2], 'bronze', '3rd');
            
            const rest = allPlayers.slice(3);
            if(rest.length === 0) { document.getElementById('runnerUps').classList.add('hidden'); } 
            else { document.getElementById('runnerUps').classList.remove('hidden'); rest.forEach((p, index) => { 
                const li = document.createElement('li'); 
                li.innerHTML = `<span><span class="player-dot" style="background:${p.color}"></span>#${index + 4} ${p.name}</span> <span>${p.score} pts</span>`; 
                runnerList.appendChild(li); 
            }); }
        });
        
        socket.on('playAgainStarted', () => location.reload());

        function addEnterKey(inputId, btnId) {
            const input = document.getElementById(inputId);
            if(input) { input.addEventListener("keypress", function(event) { if (event.key === "Enter") { event.preventDefault(); document.getElementById(btnId).click(); } }); }
        }
        addEnterKey("playerName", "joinBtn");
        addEnterKey("searchInput", "searchBtn");
        addEnterKey("guessInput", "submitGuessBtn");
        
        document.getElementById('joinBtn').onclick = () => { 
            const name = document.getElementById('playerName').value; 
            if(name) { socket.emit('joinGame', { name: name, color: myColor }); } 
        };
        
        document.getElementById('searchBtn').onclick = () => { const query = document.getElementById('searchInput').value; if(query) socket.emit('searchSongs', query); };
        document.getElementById('submitSongBtn').onclick = () => { if(selectedTrack) { socket.emit('submitSong', selectedTrack); document.getElementById('selectedSong').innerHTML = "<h3>Song Submitted! Waiting...</h3>"; document.getElementById('searchResults').classList.add('hidden'); document.getElementById('waitingArea').classList.remove('hidden'); } };
        document.getElementById('startGameBtn').onclick = () => socket.emit('startGame');
        document.getElementById('submitGuessBtn').onclick = () => { const guess = document.getElementById('guessInput').value; if(guess) socket.emit('submitGuess', guess); };
        document.getElementById('playAgainBtn').onclick = () => socket.emit('playAgain');
        function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); }
        
       // --- UPDATED LOBBY WITH KICK BUTTON ---
        function updateLobby(data) {
            const myPlayer = data.players[myId];
            if(myPlayer && document.getElementById('loginScreen').classList.contains('hidden') === false) { 
                showScreen('submissionScreen'); 
            }
            
            document.getElementById('submittedCount').textContent = data.submittedPlayers ? data.submittedPlayers.size : 0; 
            document.getElementById('totalPlayers').textContent = Object.keys(data.players).length; 
            
            const list = document.getElementById('playerList'); 
            list.innerHTML = ''; 
            
            // Check if I am the host (first player)
            const amIHost = (myId === data.hostId);

            Object.values(data.players).forEach(p => { 
                const li = document.createElement('li'); 
                
                let html = `<span><span class="player-dot" style="background:${p.color}"></span>${p.name}</span>`;
                
                // Show Kick Button only if I am Host AND this is not me
                if (amIHost && p.id !== myId) {
                    html += `
                        <div style="display:flex; align-items:center; gap:10px;">
                            ${p.hasSubmitted ? '‚úÖ' : '‚è≥'}
                            <button class="danger-btn" onclick="kickPlayer('${p.id}')">‚ùå</button>
                        </div>
                    `;
                } else {
                    html += `${p.hasSubmitted ? '‚úÖ' : '‚è≥'}`;
                }
                
                li.innerHTML = html;
                list.appendChild(li); 
            }); 
        }

        // Global Kick Function (Required for the button to work)
        window.kickPlayer = function(id) {
            if(confirm("Are you sure you want to kick this player?")) {
                socket.emit('kickPlayer', id);
            }
        };
        
        function updateScores(scores, listId) { 
            const list = document.getElementById(listId); list.innerHTML = ''; const sorted = Object.values(scores).sort((a,b) => b.score - a.score); 
            sorted.forEach(p => { 
                const li = document.createElement('li'); 
                li.innerHTML = `<span><span class="player-dot" style="background:${p.color}"></span>${p.name}</span> <span>${p.score} pts</span>`; 
                list.appendChild(li); 
            }); 
        }

        // Global Kick Function
        window.kickPlayer = function(id) {
            if(confirm("Kick this player?")) {
                socket.emit('kickPlayer', id);
            }
        };
    </script>
</body>
</html>
