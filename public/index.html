<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Not Songlio: Retro Edition</title>
    <style>
        /* --- RETRO SYNTHWAVE THEME --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body { 
            font-family: 'Courier New', Courier, monospace; 
            background: #120428; 
            color: #fff; 
            text-align: center; 
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden; 
        } 

        /* --- LAYOUT SYSTEM --- */
        #main-layout {
            display: flex;
            flex-direction: column; 
            height: 100%;
            width: 100%;
        }

        #game-column {
            flex: 3;
            overflow-y: auto; 
            padding: 10px; /* Reduced for laptop screens */
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
        }

        .container { max-width: 800px; width: 100%; }

        #chat-column {
            background: #000;
            border-top: 4px solid #ff00ff;
            padding: 10px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            position: fixed; 
            bottom: 0; 
            left: 0; 
            width: 100%;
            height: 150px; 
        }

        @media (min-width: 900px) {
            #main-layout { flex-direction: row; }
            #game-column {
                border-right: 4px solid #00ffff; 
            }
            #chat-column {
                flex: 1; 
                position: static; 
                height: 100%; 
                border-top: none; 
                border-left: 4px solid #ff00ff; 
                min-width: 300px; 
            }
            #chatBox {
                flex-grow: 1; 
                height: auto !important; 
                max-height: none !important;
            }
        }

        /* --- RESPONSIVE TYPOGRAPHY --- */
        h1 { 
            color: #ffffff;
            text-shadow: 2px 2px 0px #ff00ff; 
            margin-bottom: 10px; 
            font-size: 2rem; /* Adjusted for laptop height */
            text-transform: uppercase;
            letter-spacing: 4px;
            font-weight: 900;
            border-bottom: 2px solid #ff00ff;
            padding-bottom: 5px;
            display: inline-block;
        }

        .screen { 
            background: #000; 
            padding: 15px; 
            margin: 10px 0; 
            border: 2px solid #00ffff; 
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.2);
            width: 100%;
        }
        
        .instruction-box {
            border: 2px dashed #666;
            background: #111;
            padding: 10px;
            margin-bottom: 15px;
            text-align: left;
            font-size: 0.8rem;
            line-height: 1.4;
            color: #ccc;
        }

        .hidden { display: none !important; }

        input[type="text"] { 
            padding: 12px; 
            width: 100%; 
            border: 2px solid #ff00ff; 
            background: #220022; 
            color: #00ffff; 
            font-family: 'Courier New', monospace;
            font-size: 1rem;
            outline: none;
        }

        button { 
            padding: 12px 20px; 
            border: none; 
            cursor: pointer; 
            font-weight: bold; 
            margin: 5px; 
            background: #00ffff; 
            color: #000; 
            font-family: 'Courier New', monospace;
            text-transform: uppercase;
            font-size: 0.9rem;
            transition: all 0.1s;
        }
        button:hover { background: #fff; transform: scale(1.05); }
        
        button.host-btn { background: #ff00ff; color: #fff; }
        button.danger-btn { background: #ff3333; color: #fff; padding: 2px 8px; font-size: 0.8rem; }

        .song-item { background: #1a1a1a; padding: 8px; margin: 5px 0; cursor: pointer; border: 1px solid #333; text-align: left; }
        
        ul.retro-list li { 
            background: #000; 
            border-bottom: 1px solid #333;
            padding: 8px; 
            margin: 4px 0; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            font-size: 0.9rem;
        }

        .progress-container { width: 100%; height: 10px; background: #333; margin: 10px 0; border: 1px solid #fff; }
        .progress-bar { height: 100%; background: #00ffff; width: 0%; transition: width 0.5s; }

        #countdown { font-size: 2rem; font-weight: bold; color: #ff00ff; margin: 5px 0; }
        
        #hintText {
            font-family: 'Courier New', monospace;
            font-size: 1.8rem; 
            letter-spacing: 4px;
            color: #00ffff;
            margin: 10px 0;
            text-shadow: 2px 2px #000;
            word-break: break-word;
            line-height: 1.2;
        }

        #chatBox { 
            width: 100%; 
            height: 100px; 
            overflow-y: auto; 
            background: #111; 
            border: 1px solid #333; 
            padding: 10px; margin-bottom: 10px; text-align: left; 
            font-size: 0.85rem;
        }

        .podium-container { display: flex; justify-content: center; align-items: flex-end; height: 220px; margin-bottom: 20px; gap: 10px; }
        .pillar { 
            display: flex; flex-direction: column; justify-content: flex-end; align-items: center; 
            width: 80px; 
            border: 3px solid #fff; 
            color: #000; font-weight: bold; text-align: center; position: relative; 
        }
        .pillar-name { position: absolute; top: -35px; width: 100%; color: #fff; font-size: 0.9rem; font-weight: bold; }
        
        .gold { background: #ffff00; height: 160px; order: 2; border-color: #ffff00; }
        .silver { background: #00ffff; height: 120px; order: 1; border-color: #00ffff; }
        .bronze { background: #ff00ff; height: 80px; order: 3; border-color: #ff00ff; }

        .color-options { display: flex; justify-content: center; gap: 8px; margin: 10px 0; flex-wrap: wrap; }
        .color-dot { width: 25px; height: 25px; border: 2px solid #000; cursor: pointer; } 

        /* --- SCREEN HEIGHT SPECIFIC FIX --- */
        @media (max-height: 800px) {
            h1 { font-size: 1.5rem; margin-bottom: 5px; }
            .screen { padding: 10px; margin: 5px 0; }
            #hintText { font-size: 1.4rem; }
            #countdown { font-size: 1.8rem; }
            .instruction-box { margin-bottom: 10px; }
        }
    </style>
</head>
<body>
    <div id="main-layout">
        <div id="game-column">
            <div class="container">
                <h1>NOT SONGLIO</h1>
                
                <div class="screen" id="loginScreen">
                    <div class="instruction-box">
                        <h3 style="color:#ffff00; border-bottom:1px solid #ffff00; margin-bottom:5px;">HOW TO PLAY</h3>
                        <div>1. <span style="color:#00ffff">JOIN:</span> Enter Name & Pick Color.</div>
                        <div>2. <span style="color:#ffff00">WAIT:</span> Gather in the Lobby.</div>
                        <div>3. <span style="color:#ff00ff">PICK:</span> Everyone chooses a track.</div>
                        <div>4. <span style="color:#00ff00">PLAY:</span> Guess the song title!</div>
                    </div>

                    <h2 style="font-size:1.2rem;">CHOOSE YOUR CHARACTER</h2>
                    <input type="text" id="playerName" placeholder="ENTER NAME..." maxlength="15">
                    <div class="color-options" id="colorPicker"></div>
                    <button id="joinBtn">JOIN LOBBY</button>
                    <div id="loginStatus" class="status-message" style="color:#ff3333; display:none;"></div>
                </div>

                <div class="screen hidden" id="lobbyScreen">
                    <h2 id="lobbyHeader" style="font-size:1.3rem;">LOBBY</h2>
                    <p id="lobbyStatus" style="color:#ffff00; font-size:0.8rem; margin-bottom:10px;">WAITING FOR HOST...</p>
                    <p>PLAYERS: <span id="lobbyCount">0</span></p>
                    <ul id="lobbyList" class="retro-list"></ul>
                    <button id="openSelectionBtn" class="host-btn hidden">OPEN SONG SELECTION</button>
                </div>

                <div class="screen hidden" id="submissionScreen">
                    <h2 style="font-size:1.2rem;">SELECT TRACK</h2>
                    <div style="margin-bottom: 10px; display:flex; gap:5px;">
                        <input type="text" id="searchInput" placeholder="ARTIST OR TITLE...">
                        <button id="searchBtn" style="padding:10px;">SEARCH</button>
                    </div>
                    <div id="searchResults" class="hidden"></div>
                    <div id="selectedSong" class="hidden">
                        <h3 id="selTitle" style="color:#ffff00"></h3>
                        <p id="selArtist" style="font-size:0.9rem;"></p>
                        <audio id="previewAudio" controls style="width: 100%; height:30px; margin: 10px 0;"></audio>
                        <button id="submitSongBtn" class="host-btn">CONFIRM</button>
                    </div>
                    <div id="waitingArea" class="hidden" style="margin-top:10px; border-top:1px solid #444; padding-top:5px;">
                        <p>READY: <span id="submittedCount">0</span>/<span id="totalPlayers">0</span></p>
                        <ul id="submissionList" class="retro-list"></ul>
                    </div>
                    <div class="host-controls hidden" id="hostControls">
                        <button id="startGameBtn" class="host-btn" disabled>INITIATE GAME</button>
                    </div>
                </div>
                
                <div class="screen hidden" id="gameScreen">
                    <div class="progress-container"><div class="progress-bar" id="gameProgress"></div></div>
                    <p style="font-size:0.9rem;">TRACK <span id="trackNum">1</span> | <span id="activeSubmitter">DJ: ???</span></p>
                    <div id="hintText"></div>
                    <div id="countdown">30</div>
                    <audio id="gameAudio" style="display:none"></audio>
                    <button id="skipBtn" class="danger-btn hidden" style="display:block; margin: 5px auto;">SKIP ROUND ‚è≠Ô∏è</button>
                    
                    <div id="revealArea" class="hidden">
                        <img id="albumArt" src="" style="width:100px; border: 2px solid #fff;">
                        <h3 id="revealTitle" style="color:#ffff00; font-size: 1.2rem; margin-top:5px;">TITLE</h3>
                        <p id="revealArtist" style="color:#00ffff; font-size: 1rem;">ARTIST</p>
                        <p id="revealSubmitter" style="font-size:0.8rem; font-style:italic;">CHOSEN BY: ???</p>
                    </div>
                    
                    <div id="scoreboard" style="margin-top: 15px; text-align: left;">
                        <h3 style="border-bottom: 1px solid #fff; font-size:1rem;">HIGH SCORES</h3>
                        <ul id="scoreList" class="retro-list"></ul>
                    </div>
                </div>

                <div class="screen hidden" id="resultsScreen">
                    <h2 style="font-size:1.5rem;">üèÜ GAME OVER üèÜ</h2>
                    <div id="podium" class="podium-container"></div>
                    <div id="runnerUps" style="text-align: left;">
                        <ul id="runnerUpList" class="retro-list"></ul>
                    </div>
                    <button id="playAgainBtn" class="host-btn">CONTINUE?</button>
                </div>
            </div>
        </div>

        <div id="chat-column">
            <div id="chatBox"></div>
            <div id="guessFeedback" style="height: 18px; font-size:0.85rem; font-weight: bold; margin-bottom: 2px;"></div>
            <div id="inputRow">
                <input type="text" id="guessInput" placeholder="ENTER GUESS..." autocomplete="off">
                <button id="submitGuessBtn" style="padding:10px;">SEND</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io(); 
        let myId = null;
        let selectedTrack = null;
        let myColor = '#00ffff'; 
        let currentHostId = null;

        const colors = ['#ff00ff', '#00ffff', '#ffff00', '#00ff00', '#ff9900', '#bd00ff', '#ff3333', '#ffffff'];
        const picker = document.getElementById('colorPicker');
        if (picker) {
            colors.forEach(c => {
                const dot = document.createElement('div');
                dot.className = 'color-dot';
                dot.style.backgroundColor = c;
                dot.onclick = () => {
                    Array.from(picker.children).forEach(d => d.classList.remove('selected'));
                    dot.classList.add('selected');
                    myColor = c;
                };
                picker.appendChild(dot);
            });
            if (picker.children.length > 0) picker.children[0].classList.add('selected');
        }

        socket.on('connect', () => { myId = socket.id; });

        socket.on('gameStateSync', (data) => {
            if (data.phase !== 'lobby') {
                showScreen(data.phase === 'selection' ? 'submissionScreen' : 'gameScreen');
                if (data.phase === 'playing') document.getElementById('trackNum').textContent = data.currentRound + 1;
            }
        });
        
        socket.on('playerJoined', (data) => {
            currentHostId = data.hostId;
            updateLobby(data);
            if (!document.getElementById('loginScreen').classList.contains('hidden') && data.players[myId]) {
                if (data.phase === 'lobby') showScreen('lobbyScreen');
            }
            if(data.hostId === myId) {
                document.getElementById('openSelectionBtn').classList.remove('hidden');
                document.getElementById('hostControls').classList.remove('hidden');
            }
        });

        socket.on('selectionStarted', () => { showScreen('submissionScreen'); });
        socket.on('loginError', (msg) => { 
            const el = document.getElementById('loginStatus'); 
            el.textContent = msg; el.style.display = 'block'; 
            setTimeout(() => el.style.display = 'none', 3000); 
        });
        
        socket.on('searchResults', (results) => {
            const container = document.getElementById('searchResults');
            container.innerHTML = ''; container.classList.remove('hidden');
            results.forEach(track => {
                const div = document.createElement('div');
                div.className = 'song-item';
                div.innerHTML = `<strong>${track.trackName}</strong> - ${track.artistName}`;
                div.onclick = () => {
                    selectedTrack = track;
                    document.getElementById('selectedSong').classList.remove('hidden');
                    document.getElementById('selTitle').textContent = track.trackName;
                    document.getElementById('selArtist').textContent = track.artistName;
                    document.getElementById('previewAudio').src = track.previewUrl;
                };
                container.appendChild(div);
            });
        });

        socket.on('songSubmitted', (data) => {
            updateLobby(data); 
            if(data.isReady) document.getElementById('startGameBtn').disabled = false;
        });
        
        socket.on('gameStarted', () => { showScreen('gameScreen'); });

        socket.on('chatMessage', (data) => {
            const chatBox = document.getElementById('chatBox');
            const div = document.createElement('div');
            div.className = 'chat-msg';
            const nameSpan = `<span class="chat-name" style="color: ${data.color || '#00ffff'}">${data.name}:</span>`;
            if(data.type === 'correct') div.innerHTML = `${nameSpan} <span class="chat-correct">${data.text}</span>`;
            else if (data.type === 'winner-chat') div.innerHTML = `${nameSpan} <span class="chat-winner">${data.text}</span>`;
            else if (data.type === 'dj-chat') div.innerHTML = `${nameSpan} <span class="chat-dj">${data.text}</span>`;
            else div.innerHTML = `${nameSpan} <span class="chat-wrong">${data.text}</span>`;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        });

        socket.on('playTrack', (data) => {
            document.getElementById('revealArea').classList.add('hidden');
            document.getElementById('trackNum').textContent = data.trackIndex + 1;
            document.getElementById('hintText').textContent = data.hintMask;
            document.getElementById('activeSubmitter').textContent = "DJ: " + data.submitterName;
            
            const skipBtn = document.getElementById('skipBtn');
            if (myId === currentHostId) skipBtn.classList.remove('hidden');
            else skipBtn.classList.add('hidden');

            const input = document.getElementById('guessInput');
            input.value = ''; input.disabled = false; input.classList.remove('input-winner');
            input.placeholder = "ENTER GUESS..."; input.focus();
            
            document.getElementById('guessFeedback').textContent = '';
            const audio = document.getElementById('gameAudio');
            audio.src = data.track.previewUrl; audio.volume = 0.5;
            audio.play().catch(e => console.log("Autoplay blocked"));
        });

        socket.on('revealHint', (data) => {
            const el = document.getElementById('hintText');
            const currentChars = el.textContent.split('');
            currentChars[data.index] = data.char;
            el.textContent = currentChars.join('');
        });

        socket.on('countdown', (t) => {
            document.getElementById('countdown').textContent = t;
            document.getElementById('gameProgress').style.width = (t / 30 * 100) + "%";
        });
        
        socket.on('roundEnded', (data) => {
            document.getElementById('revealArea').classList.remove('hidden');
            document.getElementById('revealTitle').textContent = data.track.title;
            document.getElementById('revealArtist').textContent = data.track.artist;
            document.getElementById('revealSubmitter').textContent = "CHOSEN BY: " + data.submitterName;
            document.getElementById('albumArt').src = data.track.albumArt || '';
            document.getElementById('gameAudio').pause();
            document.getElementById('hintText').textContent = "";
            document.getElementById('skipBtn').classList.add('hidden');
            updateScores(data.scores, 'scoreList');
            document.getElementById('guessInput').placeholder = "ROUND OVER. CHAT ENABLED.";
        });

        socket.on('guessResult', (data) => {
            const fb = document.getElementById('guessFeedback');
            const input = document.getElementById('guessInput');
            if(data.silent) { input.value = ''; return; }
            if(data.correct) {
                fb.textContent = `‚úÖ CORRECT! +${data.points}`;
                fb.style.color = "#00ff00";
                input.classList.add('input-winner');
                input.placeholder = "CHAT MODE...";
                input.value = '';
            } else {
                fb.textContent = data.message ? "‚ö†Ô∏è " + data.message : "‚ùå INCORRECT";
                fb.style.color = "#ff3333";
                input.value = ''; 
            }
        });

        socket.on('gameFinished', (data) => {
            showScreen('resultsScreen');
            const duration = 3000;
            const end = Date.now() + duration;
            (function frame() {
                confetti({ particleCount: 5, angle: 60, spread: 55, origin: { x: 0 }, colors: ['#ff00ff', '#00ffff'] });
                confetti({ particleCount: 5, angle: 120, spread: 55, origin: { x: 1 }, colors: ['#ff00ff', '#00ffff'] });
                if (Date.now() < end) requestAnimationFrame(frame);
            }());

            const podium = document.getElementById('podium');
            const runnerList = document.getElementById('runnerUpList');
            podium.innerHTML = ''; runnerList.innerHTML = '';
            const allPlayers = Object.values(data.scores).sort((a,b) => b.score - a.score);
            const top3 = allPlayers.slice(0, 3);
            
            const createPillar = (p, rankClass, rankNum) => {
                if(!p) return;
                const div = document.createElement('div');
                div.className = `pillar ${rankClass}`;
                div.innerHTML = `<div class="pillar-name" style="color:${p.color}">${p.name}</div><div style="font-size:1.5rem; opacity:0.4;">${rankNum}</div><div style="font-size:1rem;">${p.score}</div>`;
                podium.appendChild(div);
            };
            createPillar(top3[1], 'silver', '2'); createPillar(top3[0], 'gold', '1'); createPillar(top3[2], 'bronze', '3');
            
            const rest = allPlayers.slice(3);
            rest.forEach((p, i) => { 
                const li = document.createElement('li'); 
                li.innerHTML = `<span>#${i + 4} ${p.name}</span> <span>${p.score} PTS</span>`; 
                runnerList.appendChild(li); 
            });
        });
        
        socket.on('playAgainStarted', () => location.reload());

        function addEnterKey(inputId, btnId) {
            const input = document.getElementById(inputId);
            if(input) input.addEventListener("keypress", (e) => { if (e.key === "Enter") { e.preventDefault(); document.getElementById(btnId).click(); } });
        }
        addEnterKey("playerName", "joinBtn"); addEnterKey("searchInput", "searchBtn"); addEnterKey("guessInput", "submitGuessBtn");
        
        document.getElementById('joinBtn').onclick = () => { 
            const name = document.getElementById('playerName').value; 
            if(name) socket.emit('joinGame', { name, color: myColor }); 
        };
        
        document.getElementById('openSelectionBtn').onclick = () => {
            if(confirm("LOCKED LOBBY: No new players can join once selection starts. Proceed?")) socket.emit('openSongSelection');
        };

        document.getElementById('searchBtn').onclick = () => { const q = document.getElementById('searchInput').value; if(q) socket.emit('searchSongs', q); };
        document.getElementById('submitSongBtn').onclick = () => { 
            if(selectedTrack) { 
                socket.emit('submitSong', selectedTrack); 
                document.getElementById('selectedSong').innerHTML = "<h3>CONFIRMED</h3>"; 
                document.getElementById('searchResults').classList.add('hidden'); 
                document.getElementById('waitingArea').classList.remove('hidden'); 
            } 
        };
        document.getElementById('startGameBtn').onclick = () => socket.emit('startGame');
        document.getElementById('submitGuessBtn').onclick = () => { const g = document.getElementById('guessInput').value; if(g) socket.emit('submitGuess', g); };
        document.getElementById('playAgainBtn').onclick = () => socket.emit('playAgain');
        document.getElementById('skipBtn').onclick = () => { if(confirm("Skip this track?")) socket.emit('skipRound'); };

        function showScreen(id) { 
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden')); 
            document.getElementById(id).classList.remove('hidden'); 
        }
        
        function updateLobby(data) {
            document.getElementById('submittedCount').textContent = data.submittedPlayers ? data.submittedPlayers.length : 0; 
            const total = Object.keys(data.players).length;
            document.getElementById('totalPlayers').textContent = total; 
            document.getElementById('lobbyCount').textContent = total;
            if (data.phase !== 'lobby') document.getElementById('lobbyHeader').innerHTML = "LOBBY - <span style='color:#ff3333'>LOCKED</span>";

            const lobbyList = document.getElementById('lobbyList'); 
            const subList = document.getElementById('submissionList');
            lobbyList.innerHTML = ''; subList.innerHTML = '';
            const amIHost = (myId === data.hostId);
            Object.values(data.players).forEach(p => { 
                const li = document.createElement('li'); 
                const crown = (p.id === data.hostId) ? ' üëë' : '';
                let html = `<span>${p.name}${crown}</span>`;
                if (amIHost && p.id !== myId) html += `<div>${p.hasSubmitted ? '‚úÖ' : '‚è≥'}<button class="danger-btn" onclick="kickPlayer('${p.id}')">‚ùå</button></div>`;
                else html += `${p.hasSubmitted ? '‚úÖ' : '‚è≥'}`;
                li.innerHTML = html;
                lobbyList.appendChild(li.cloneNode(true)); subList.appendChild(li);            
            }); 
        }
        
        function updateScores(scores, listId) { 
            const list = document.getElementById(listId); list.innerHTML = ''; 
            Object.values(scores).sort((a,b) => b.score - a.score).forEach(p => { 
                const li = document.createElement('li'); 
                li.innerHTML = `<span>${p.name}</span> <span>${p.score} PTS</span>`; 
                list.appendChild(li); 
            }); 
        }

        window.kickPlayer = (id) => { if(confirm("EJECT PLAYER?")) socket.emit('kickPlayer', id); };
    </script>
</body>
</html>
