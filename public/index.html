<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Not Songlio: Retro Edition</title>
    <style>
        /* --- RETRO SYNTHWAVE THEME --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: 'Courier New', Courier, monospace; 
            background: #120428; 
            color: #fff; 
            padding: 20px; 
            text-align: center; 
            padding-bottom: 200px; 
        } 
        .container { max-width: 800px; margin: 0 auto; }
        
        h1 { 
            color: #ffffff;
            text-shadow: 4px 4px 0px #ff00ff; 
            margin-bottom: 30px; 
            font-size: 3rem;
            text-transform: uppercase;
            letter-spacing: 4px;
            font-weight: 900;
            border-bottom: 2px solid #ff00ff;
            padding-bottom: 10px;
            display: inline-block;
        }

        .screen { 
            background: #000; 
            padding: 25px; 
            margin: 20px 0; 
            border: 2px solid #00ffff; 
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.2);
        }
        
        .hidden { display: none !important; }

        input[type="text"] { 
            padding: 15px; 
            width: 70%; 
            border: 2px solid #ff00ff; 
            background: #220022; 
            color: #00ffff; 
            font-family: 'Courier New', monospace;
            font-size: 1.2rem;
            outline: none;
        }
        input::placeholder { color: #884488; }

        button { 
            padding: 15px 25px; 
            border: none; 
            cursor: pointer; 
            font-weight: bold; 
            margin: 5px; 
            background: #00ffff; 
            color: #000; 
            font-family: 'Courier New', monospace;
            text-transform: uppercase;
            font-size: 1rem;
            transition: all 0.1s;
        }
        button:hover { background: #fff; transform: scale(1.05); }
        button:disabled { background: #333; color: #666; cursor: not-allowed; transform: none; }
        
        button.host-btn { background: #ff00ff; color: #fff; }
        button.danger-btn { background: #ff3333; color: #fff; padding: 2px 8px; font-size: 0.8rem; margin: 0 0 0 10px; }

        .song-item { background: #1a1a1a; padding: 10px; margin: 5px 0; cursor: pointer; border: 1px solid #333; text-align: left; }
        .song-item:hover { background: #222; border-color: #00ffff; }
        .song-item.selected { border-left: 8px solid #ff00ff; background: #220022; }

        #playerList li, #scoreList li, #runnerUpList li { 
            background: #000; 
            border-bottom: 1px solid #333;
            padding: 10px; 
            margin: 5px 0; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }

        .progress-container { width: 100%; height: 15px; background: #333; margin: 15px 0; border: 1px solid #fff; }
        .progress-bar { height: 100%; background: #00ffff; width: 0%; transition: width 0.5s; }

        #countdown { font-size: 3rem; font-weight: bold; color: #ff00ff; margin: 10px 0; text-shadow: 2px 2px #000; }
        
        .guess-correct { color: #00ff00; font-weight: bold; margin: 10px; font-size: 1.2rem; text-transform: uppercase; }
        .guess-incorrect { color: #ff3333; font-weight: bold; margin: 10px; text-transform: uppercase; }
        
        #bottomPanel { 
            position: fixed; bottom: 0; left: 0; width: 100%; 
            background: #000; 
            border-top: 4px solid #ff00ff; 
            padding: 10px; z-index: 100; 
            display: flex; flex-direction: column; align-items: center; 
        }
        #chatBox { 
            width: 90%; max-width: 800px; height: 120px; 
            overflow-y: auto; background: #111; 
            border: 1px solid #333; 
            padding: 10px; margin-bottom: 10px; text-align: left; 
            font-size: 0.9rem;
        }
        #inputRow { width: 100%; max-width: 800px; display: flex; gap: 10px; }
        #inputRow input { flex: 1; }
        
        .chat-msg { margin: 2px 0; }
        .chat-name { font-weight: bold; text-transform: uppercase; }
        .chat-correct { color: #00ff00; }
        .chat-winner { color: #ffff00; }
        .chat-dj { color: #ff00ff; }
        .chat-wrong { color: #666; }
        .input-winner { border: 2px solid #00ff00 !important; color: #00ff00 !important; }

        /* NEON PODIUM */
        .podium-container { display: flex; justify-content: center; align-items: flex-end; height: 300px; margin-bottom: 30px; gap: 10px; }
        .pillar { 
            display: flex; flex-direction: column; justify-content: flex-end; align-items: center; 
            width: 100px; 
            border: 3px solid #fff; 
            color: #000; font-weight: bold; text-align: center; padding-bottom: 10px; position: relative; 
        }
        .pillar-name { position: absolute; top: -40px; width: 100%; color: #fff; font-size: 1.1rem; font-weight: bold; text-shadow: 2px 2px #000; }
        .pillar-score { font-size: 1.5rem; }
        .rank-label { font-size: 2rem; opacity: 0.5; margin-bottom: 10px; font-weight: bold;}
        
        .gold { background: #ffff00; height: 220px; order: 2; z-index: 10; box-shadow: 0 0 30px #ffff00; border-color: #ffff00; }
        .silver { background: #00ffff; height: 160px; order: 1; box-shadow: 0 0 20px #00ffff; border-color: #00ffff; }
        .bronze { background: #ff00ff; height: 110px; order: 3; box-shadow: 0 0 20px #ff00ff; border-color: #ff00ff; }
        
        #activeSubmitter { font-style: italic; color: #ff00ff; margin-bottom: 10px; }
        .status-message { color: #ff3333; margin-top: 10px; font-weight: bold; display: none; }

        .color-options { display: flex; justify-content: center; gap: 10px; margin: 15px 0; flex-wrap: wrap; }
        .color-dot { width: 30px; height: 30px; border: 2px solid #000; cursor: pointer; transition: transform 0.2s; } 
        .color-dot:hover { transform: scale(1.2); border-color: #fff; }
        .color-dot.selected { border: 3px solid #fff; transform: scale(1.1); box-shadow: 0 0 10px #fff; }
        .player-dot { width: 12px; height: 12px; margin-right: 10px; display: inline-block; border: 1px solid #fff; }
    </style>
</head>
<body>
    <div class="container">
        <h1>NOT SONGLIO</h1>
        
        <div class="screen" id="loginScreen">
            <h2>CHOOSE YOUR CHARACTER</h2>
            <input type="text" id="playerName" placeholder="ENTER NAME..." maxlength="15">
            <p style="margin: 15px 0 5px; font-size: 0.8rem; color: #00ffff;">SELECT COLOR:</p>
            <div class="color-options" id="colorPicker"></div>
            <br>
            <button id="joinBtn">START GAME</button>
            <div id="loginStatus" class="status-message"></div>
        </div>

        <div class="screen hidden" id="submissionScreen">
            <h2>SELECT TRACK</h2>
            <div style="margin-bottom: 15px;">
                <input type="text" id="searchInput" placeholder="ARTIST OR TITLE...">
                <button id="searchBtn">SEARCH</button>
            </div>
            <div id="searchResults" class="hidden"></div>
            <div id="selectedSong" class="hidden">
                <h3 id="selTitle" style="color:#ffff00"></h3>
                <p id="selArtist"></p>
                <audio id="previewAudio" controls style="width: 100%; margin: 10px 0;"></audio>
                <br>
                <button id="submitSongBtn" class="host-btn">CONFIRM SELECTION</button>
            </div>
            <div id="waitingArea" class="hidden" style="margin-top:20px; border-top:1px solid #444; padding-top:10px;">
                <h3>WAITING FOR PLAYERS...</h3>
                <p>READY: <span id="submittedCount">0</span>/<span id="totalPlayers">0</span></p>
                <ul id="playerList"></ul>
            </div>
            <div class="host-controls hidden" id="hostControls">
                <button id="startGameBtn" class="host-btn" disabled>INITIATE GAME</button>
            </div>
        </div>
        
        <div class="screen hidden" id="gameScreen">
            <h2>GUESS THE TRACK</h2>
            <div class="progress-container"><div class="progress-bar" id="gameProgress"></div></div>
            <p>TRACK <span id="trackNum">1</span></p>
            <p id="activeSubmitter">DJ: ???</p>
            <div id="countdown">30</div>
            <audio id="gameAudio" style="display:none"></audio>
            
            <div id="revealArea" class="hidden">
                <img id="albumArt" src="" style="width:150px; border: 2px solid #fff;">
                <h3 id="revealTitle" style="color:#ffff00; margin-top:10px;">TITLE</h3>
                <p id="revealArtist" style="color:#00ffff">ARTIST</p>
                <p id="revealSubmitter" style="color:#ff00ff; font-style:italic;">CHOSEN BY: ???</p>
            </div>
            
            <div id="scoreboard" style="margin-top: 30px; text-align: left;">
                <h3 style="border-bottom: 2px solid #fff; padding-bottom: 5px;">HIGH SCORES</h3>
                <ul id="scoreList"></ul>
            </div>
        </div>

        <div class="screen hidden" id="resultsScreen">
            <h2>üèÜ GAME OVER üèÜ</h2>
            <div id="podium" class="podium-container"></div>
            <div id="runnerUps" style="text-align: left; margin-top: 30px;">
                <h3>RANKINGS</h3>
                <ul id="runnerUpList"></ul>
            </div>
            <button id="playAgainBtn" class="host-btn" style="margin-top: 20px;">CONTINUE?</button>
        </div>
    </div>

    <div id="bottomPanel" class="hidden">
        <div id="chatBox"></div>
        <div id="inputRow">
            <input type="text" id="guessInput" placeholder="ENTER GUESS..." autocomplete="off">
            <button id="submitGuessBtn">SEND</button>
        </div>
        <div id="guessFeedback" style="height: 20px; margin-top: 5px; font-weight: bold;"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io(); 
        let myId = null;
        let selectedTrack = null;
        let myColor = '#00ffff'; 

        const colors = ['#ff00ff', '#00ffff', '#ffff00', '#00ff00', '#ff9900', '#bd00ff', '#ff3333', '#ffffff'];
        
        const picker = document.getElementById('colorPicker');
        if (picker) {
            picker.innerHTML = ''; 
            colors.forEach(c => {
                const dot = document.createElement('div');
                dot.className = 'color-dot';
                dot.style.backgroundColor = c;
                dot.onclick = () => {
                    Array.from(picker.children).forEach(d => d.classList.remove('selected'));
                    dot.classList.add('selected');
                    myColor = c;
                };
                picker.appendChild(dot);
            });
            if (picker.children.length > 0) {
                picker.children[0].classList.add('selected');
                myColor = colors[0];
            }
        }

        socket.on('connect', () => { myId = socket.id; });
        socket.on('playerJoined', (data) => {
            updateLobby(data);
            if(data.hostId === myId) document.getElementById('hostControls').classList.remove('hidden');
        });
        socket.on('loginError', (msg) => { const el = document.getElementById('loginStatus'); el.textContent = msg; el.style.display = 'block'; setTimeout(() => el.style.display = 'none', 3000); });
        socket.on('searchResults', (results) => {
            const container = document.getElementById('searchResults');
            container.innerHTML = '';
            container.classList.remove('hidden');
            results.forEach(track => {
                const div = document.createElement('div');
                div.className = 'song-item';
                div.innerHTML = `<strong>${track.trackName}</strong> - ${track.artistName}`;
                div.onclick = () => {
                    selectedTrack = track;
                    document.getElementById('selectedSong').classList.remove('hidden');
                    document.getElementById('selTitle').textContent = track.trackName;
                    document.getElementById('selArtist').textContent = track.artistName;
                    document.getElementById('previewAudio').src = track.previewUrl;
                };
                container.appendChild(div);
            });
        });
        socket.on('songSubmitted', (data) => {
            updateLobby(data);
            if(data.isReady) document.getElementById('startGameBtn').disabled = false;
        });
        
        socket.on('gameStarted', (data) => {
            showScreen('gameScreen');
            document.getElementById('bottomPanel').classList.remove('hidden');
        });

        socket.on('chatMessage', (data) => {
            const chatBox = document.getElementById('chatBox');
            const div = document.createElement('div');
            div.className = 'chat-msg';
            const nameSpan = `<span class="chat-name" style="color: ${data.color || '#00ffff'}">${data.name}:</span>`;
            if(data.type === 'correct') {
                div.innerHTML = `${nameSpan} <span class="chat-correct">${data.text}</span>`;
            } else if (data.type === 'winner-chat') {
                div.innerHTML = `${nameSpan} <span class="chat-winner">${data.text}</span>`;
            } else if (data.type === 'dj-chat') {
                div.innerHTML = `${nameSpan} <span class="chat-dj">${data.text}</span>`;
            } else {
                div.innerHTML = `${nameSpan} <span class="chat-wrong">${data.text}</span>`;
            }
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        });

        socket.on('playTrack', (data) => {
            document.getElementById('revealArea').classList.add('hidden');
            const chatBox = document.getElementById('chatBox');
            const separator = document.createElement('div');
            separator.style.cssText = "text-align: center; opacity: 0.5; margin: 10px 0; font-size: 0.8rem; border-top: 1px solid #333; padding-top: 5px; color: #ff00ff;";
            separator.textContent = `--- ROUND ${data.trackIndex + 1} ---`;
            chatBox.appendChild(separator);
            document.getElementById('activeSubmitter').textContent = "DJ: " + data.submitterName;
            const input = document.getElementById('guessInput');
            input.value = '';
            input.disabled = false;
            input.classList.remove('input-winner');
            input.placeholder = "ENTER GUESS...";
            input.focus();
            document.getElementById('guessFeedback').textContent = '';
            document.getElementById('trackNum').textContent = data.trackIndex + 1;
            const audio = document.getElementById('gameAudio');
            audio.src = data.track.previewUrl;
            audio.volume = 0.5;
            audio.play().catch(e => console.log("Autoplay blocked"));
            document.getElementById('countdown').textContent = data.roundCountdown;
        });

        socket.on('countdown', (t) => document.getElementById('countdown').textContent = t);
        
        socket.on('roundEnded', (data) => {
            document.getElementById('revealArea').classList.remove('hidden');
            document.getElementById('revealTitle').textContent = data.track.title;
            document.getElementById('revealArtist').textContent = data.track.artist;
            document.getElementById('revealSubmitter').textContent = "CHOSEN BY: " + data.submitterName;
            document.getElementById('albumArt').src = data.track.albumArt || '';
            document.getElementById('gameAudio').pause();
            updateScores(data.scores, 'scoreList');
            const input = document.getElementById('guessInput');
            input.placeholder = "ROUND OVER. CHAT ENABLED.";
        });

        socket.on('guessResult', (data) => {
            const fb = document.getElementById('guessFeedback');
            const input = document.getElementById('guessInput');
            if(data.silent) { input.value = ''; input.focus(); return; }
            if(data.correct) {
                fb.textContent = `‚úÖ CORRECT! +${data.points}`;
                fb.className = "guess-correct";
                input.classList.add('input-winner');
                input.placeholder = "CHAT MODE ACTIVATED...";
                input.value = '';
                input.focus();
            } else {
                fb.textContent = data.message ? "‚ö†Ô∏è " + data.message : "‚ùå INCORRECT";
                fb.className = "guess-incorrect";
                input.value = ''; 
                input.disabled = false;
                input.focus();
            }
        });

        socket.on('gameFinished', (data) => {
            showScreen('resultsScreen');
            
            const duration = 3000;
            const end = Date.now() + duration;
            (function frame() {
                confetti({ particleCount: 5, angle: 60, spread: 55, origin: { x: 0 }, colors: ['#ff00ff', '#00ffff'] });
                confetti({ particleCount: 5, angle: 120, spread: 55, origin: { x: 1 }, colors: ['#ff00ff', '#00ffff'] });
                if (Date.now() < end) requestAnimationFrame(frame);
            }());

            const podium = document.getElementById('podium');
            const runnerList = document.getElementById('runnerUpList');
            podium.innerHTML = '';
            runnerList.innerHTML = '';
            const allPlayers = Object.values(data.scores).sort((a,b) => b.score - a.score);
            const top3 = allPlayers.slice(0, 3);
            
            const createPillar = (player, rankClass, rankNum) => {
                if(!player) return;
                const div = document.createElement('div');
                div.className = `pillar ${rankClass}`;
                div.innerHTML = `<div class="pillar-name" style="color:${player.color}">${player.name}</div><div class="rank-label">${rankNum}</div><div class="pillar-score">${player.score}</div>`;
                podium.appendChild(div);
            };
            createPillar(top3[1], 'silver', '2ND');
            createPillar(top3[0], 'gold', '1ST');
            createPillar(top3[2], 'bronze', '3RD');
            
            const rest = allPlayers.slice(3);
            if(rest.length === 0) { document.getElementById('runnerUps').classList.add('hidden'); } 
            else { document.getElementById('runnerUps').classList.remove('hidden'); rest.forEach((p, index) => { 
                const li = document.createElement('li'); 
                li.innerHTML = `<span><span class="player-dot" style="background:${p.color}"></span>#${index + 4} ${p.name}</span> <span>${p.score} PTS</span>`; 
                runnerList.appendChild(li); 
            }); }
        });
        
        socket.on('resetGame', (data) => {
            selectedTrack = null;
            document.getElementById('searchInput').value = '';
            document.getElementById('searchResults').classList.add('hidden');
            document.getElementById('selectedSong').classList.add('hidden');
            document.getElementById('waitingArea').classList.add('hidden');
            document.getElementById('startGameBtn').disabled = true;
            showScreen('submissionScreen');
            updateLobby(data);
        });

        function addEnterKey(inputId, btnId) {
            const input = document.getElementById(inputId);
            if(input) { input.addEventListener("keypress", function(event) { if (event.key === "Enter") { event.preventDefault(); document.getElementById(btnId).click(); } }); }
        }
        addEnterKey("playerName", "joinBtn");
        addEnterKey("searchInput", "searchBtn");
        addEnterKey("guessInput", "submitGuessBtn");
        
        document.getElementById('joinBtn').onclick = () => { 
            const name = document.getElementById('playerName').value; 
            if(name) { socket.emit('joinGame', { name: name, color: myColor }); } 
        };
        
        document.getElementById('searchBtn').onclick = () => { const query = document.getElementById('searchInput').value; if(query) socket.emit('searchSongs', query); };
        document.getElementById('submitSongBtn').onclick = () => { if(selectedTrack) { socket.emit('submitSong', selectedTrack); document.getElementById('selectedSong').innerHTML = "<h3>TRACK CONFIRMED</h3>"; document.getElementById('searchResults').classList.add('hidden'); document.getElementById('waitingArea').classList.remove('hidden'); } };
        document.getElementById('startGameBtn').onclick = () => socket.emit('startGame');
        document.getElementById('submitGuessBtn').onclick = () => { const guess = document.getElementById('guessInput').value; if(guess) socket.emit('submitGuess', guess); };
        document.getElementById('playAgainBtn').onclick = () => socket.emit('playAgain');
        function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); }
        
        function updateLobby(data) {
            const myPlayer = data.players[myId];
            if(myPlayer && document.getElementById('loginScreen').classList.contains('hidden') === false) { showScreen('submissionScreen'); }
            
            document.getElementById('submittedCount').textContent = data.submittedPlayers ? data.submittedPlayers.size : 0; 
            document.getElementById('totalPlayers').textContent = Object.keys(data.players).length; 
            
            const list = document.getElementById('playerList'); 
            list.innerHTML = ''; 
            
            const amIHost = (myId === data.hostId);

            Object.values(data.players).forEach(p => { 
                const li = document.createElement('li'); 
                
                let html = `<span><span class="player-dot" style="background:${p.color}"></span>${p.name}</span>`;
                
                if (amIHost && p.id !== myId) {
                    html += `<div style="display:flex; align-items:center; gap:10px;">${p.hasSubmitted ? '‚úÖ' : '‚è≥'}<button class="danger-btn" onclick="kickPlayer('${p.id}')">‚ùå</button></div>`;
                } else {
                    html += `${p.hasSubmitted ? '‚úÖ' : '‚è≥'}`;
                }
                
                li.innerHTML = html;
                list.appendChild(li); 
            }); 
        }
        
        function updateScores(scores, listId) { 
            const list = document.getElementById(listId); list.innerHTML = ''; const sorted = Object.values(scores).sort((a,b) => b.score - a.score); 
            sorted.forEach(p => { 
                const li = document.createElement('li'); 
                li.innerHTML = `<span><span class="player-dot" style="background:${p.color}"></span>${p.name}</span> <span>${p.score} PTS</span>`; 
                list.appendChild(li); 
            }); 
        }

        window.kickPlayer = function(id) {
            if(confirm("EJECT PLAYER?")) {
                socket.emit('kickPlayer', id);
            }
        };
    </script>
</body>
</html>
